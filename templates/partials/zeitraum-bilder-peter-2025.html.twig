<html lang="de">
<head>
<meta charset="UTF-8">
<title>Galerie mit Auswahl & Lightbox</title>

<script src="user/pages/tecartmedia/jszip/3.10.1/jszip.min.js"></script>
<script src="user/pages/tecartmedia/FileSaver.js/2.0.5/FileSaver.min.js"></script>





{% set imageFolder = page.header.imagefolder %}
{% set dates = [] %}
{% set images_list = [] %}

{% if imageFolder is not empty %}
  {% set folderPage = page.find(imageFolder) %}
  {% if folderPage and folderPage.children|length > 0 %}
    {% for child in folderPage.children %}
      {% for mediaItem in child.media.images|default([]) %}
        {% set mediaDate = mediaItem.modified %}
        {% if mediaDate is not empty %}
          {% set dates = dates|merge([mediaDate]) %}
        {% endif %}
        {% set images_list = images_list|merge([mediaItem]) %}
      {% endfor %}
    {% endfor %}
  {% endif %}
{% endif %}

<style>
/* === Galerie Grid === */
#media-gallery {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
  gap: 10px;
  padding: 10px;
}
#media-gallery img {
  width: 100%;
  aspect-ratio: 1/1;
  object-fit: cover;
  border-radius: 10px;
  cursor: pointer;
  transition: transform 0.25s ease;
}
.gallery-item:hover img { transform: scale(1.03); }

/* Mobile 2-column */
@media (max-width: 600px) {
  #media-gallery { grid-template-columns: repeat(2, 1fr); gap: 8px; }
  #media-gallery img { border-radius: 5px; }
}

/* Galerie-Item & Checkbox */
.gallery-item { position: relative; }
.select-image {
  position: absolute; top: 10px; left: 10px;
  width: 24px; height: 24px;
  appearance: auto; border: 2px solid #486144;
  border-radius: 4px; cursor: pointer; z-index: 400;
}
.select-image:checked { background-color: #486144; border-color: #486144; }
.select-image:checked::after {
  content: "✔"; position: absolute; top: -2px; left: 5px; color: white; font-size: 16px;
}
.select-image:checked + img {
  outline: 4px solid #486144; outline-offset: -4px; border-radius: 8px;
}

/* Download-Button in Galerie */
.download-btn {
  position: absolute; bottom: 6px; right: 6px;
  background: rgba(0,0,0,0.6); color: #fff;
  text-decoration: none; font-size: 14px; padding: 4px 6px; border-radius: 4px;
  opacity: 0; transition: opacity 0.2s ease, background 0.2s ease;
}
.gallery-item:hover .download-btn { opacity: 1; }
.download-btn:hover { background: rgba(255,255,255,0.9); color: #000; }

/* Buttons immer sichtbar */
#gallery-controls-wrapper {
  position: fixed;
  top: 120px;
  left: 60px;
  z-index: 999;
  background-color: rgba(255,255,255,0.95);
  padding: 4px;
  border-radius: 8px;
  display: flex;
  flex-direction: column;
  gap: 8px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
  max-width: 200px;
}
.gallery-button { margin-right:8px; padding:8px 12px; background:#486144; color:white; border:none; border-radius:6px; cursor:pointer; }
.gallery-button:active { transform: translateY(1px); }

@media (max-width: 600px) {
  #gallery-controls-wrapper { top: 80px; left: 15px; max-width: 90%; padding: 0; }
  .gallery-button { width: 100%; }
}

/* === Lightbox === */
#lightbox { display:none; position:fixed; z-index:10000; left:0; top:0; width:100%; height:100%; background: rgba(0,0,0,0.95); align-items:center; justify-content:center; overflow:hidden; }
#lightbox.active { display:flex; }
#lightbox img { max-width: 90%; max-height: 80%; transition: transform 0.12s ease; cursor: grab; border-radius:6px; }
#lightbox img.dragging { cursor: grabbing; }

/* Lightbox Buttons */
.lightbox-btn {
  display: flex;
  justify-content: center;
  align-items: center;
  font-size: 22px;
  color: white;
  background: rgba(0,0,0,0.5);
  padding: 6px 10px;
  border-radius: 6px;
  cursor: pointer;
  text-decoration: none;
  line-height: 1;
  user-select: none;
  transition: background 0.25s ease, color 0.25s ease;
}
.lightbox-btn:hover { background: rgba(255,255,255,0.9); color:black; }

/* Close Button oben rechts */
.close-btn {
  position: absolute;
  top: 20px;
  right: 20px;
  z-index: 1020;
}

/* Prev/Next Buttons links/rechts */
.prev-btn { position: absolute; top: 50%; left: 20px; transform: translateY(-50%); z-index: 1015; font-size: 30px; }
.next-btn { position: absolute; top: 50%; right: 20px; transform: translateY(-50%); z-index: 1015; font-size: 30px; }

/* Rechte Button-Leiste (Zoom + Download) */
#lightbox-controls {
  position: absolute;
  top: 70px;
  right: 20px;
  display: flex;
  flex-direction: column;
  gap: 10px;
  z-index: 1015;
}

/* Alle Buttons in der rechten Leiste */
#lightbox-controls .lightbox-btn {
  position: static; /* Keine absolute Position */
}

/* Zoom Info unter den Buttons */
.zoom-info {
  font-size: 14px;
  color: white;
  background: rgba(0,0,0,0.5);
  padding: 5px 8px;
  border-radius: 6px;
  text-align: center;
}

/* Thumbnails unten */
#lightbox-thumbs {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  display: flex;
  gap: 6px;
  padding: 6px 10px;
  overflow-x: auto;
  background: rgba(0,0,0,0.7);
  z-index: 1012;
  box-sizing: border-box;
  scrollbar-width: thin;
}
#lightbox-thumbs img {
  height: 60px;
  flex: 0 0 auto;
  cursor: pointer;
  border: 2px solid transparent;
  border-radius: 4px;
  transition: transform 0.2s ease, border-color 0.2s ease;
}
#lightbox-thumbs img.active {
  border-color: #fff;
  transform: scale(1.05);
}
#lightbox-thumbs::-webkit-scrollbar { height: 6px; }
#lightbox-thumbs::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 3px; }

.zoom-info {
  font-size:14px;
  color:white;
  background: rgba(0,0,0,0.5);
  padding:5px 8px;
  border-radius:6px;
  opacity:0;
  transition: opacity 0.35s ease;
  z-index:1010;
}
.zoom-info.visible { opacity:1; }

/* --- Zoom Info Desktop --- */
#zoomInfo {
  position: absolute;
  top: 170px;
  right: 20px;
}

@media (max-width: 600px) {
  /* Button-Leiste oben horizontal */
  #lightbox-controls {
    flex-direction: row;       
    justify-content: center;   
    top: 20px;                 
    bottom: auto;
    left: 50%;
    transform: translateX(-50%);
    gap: 12px;
  }

  /* Download-Button als letzter in der Leiste */
  #lightbox-download {
    order: 99;                 
  }

/* --- Zoom Info nur für Mobile --- */
   #zoomInfo {
    display: none !important;
  }
}










</style>

</head>


<body>





<div class="gallery-controls">
  {% if dates|length > 0 %}
    {% set startDate = dates|sort|first %}
    {% set endDate = dates|sort|last %}
    <div class="gallery-button">
      <strong>Zeitraum:</strong> {{ startDate|date("d.m.Y") }} – {{ endDate|date("d.m.Y") }}
    </div>
    <br>
  {% endif %}
  <div id="gallery-controls-wrapper">
  <button id="show-gallery-btn" class="gallery-button">Galerie anzeigen</button>
  <button id="hide-gallery-btn" class="gallery-button" style="display:none;">Galerie schließen</button>
  <button id="download-selected" class="gallery-button" style="display:none;">
    Ausgewählte herunterladen (ZIP)
  </button>
  <button id="toggle-select" class="gallery-button" style="display:none;">
    Alle auswählen
  </button>
  </div>

</div>

<div id="media-gallery" style="display:none;">
  {% if images_list|length > 0 %}
    {% for img in images_list %}
     <div class="gallery-item">
  <input type="checkbox" class="select-image">
  <img src="{{ img.url }}" alt="{{ img.title ?: img.filename }}" loading="lazy" data-filename="{{ img.filename }}" data-index="{{ loop.index0 }}">
  <a href="{{ img.url }}" download="{{ img.filename }}" class="download-btn" title="Bild herunterladen">⬇️</a>
</div>

    {% endfor %}
  {% else %}
    <p>Keine Bilder in diesem Ordner.</p>
  {% endif %}
</div>



<!-- Lightbox -->
<!-- Lightbox -->
<div id="lightbox" aria-hidden="true">

  <!-- Close-Button separat oben rechts -->
  <span class="lightbox-btn close-btn" aria-label="Schließen">✕</span>

  <!-- Prev/Next Buttons links/rechts -->
  <span class="lightbox-btn prev-btn" aria-label="Vorheriges">⟨</span>
  <span class="lightbox-btn next-btn" aria-label="Nächstes">⟩</span>

  <!-- Rechter Button-Container (Zoom + Download) -->
  <div id="lightbox-controls">
    <span class="lightbox-btn zoom-in">＋</span>
    <span class="lightbox-btn zoom-out">－</span>
    <a id="lightbox-download" class="lightbox-btn" href="#" download title="Herunterladen">↓</a>
    <div class="zoom-info" id="zoomInfo">100%</div>
  </div>

  
      
  <!-- Hauptbild -->
  <img id="lightbox-img" src="" alt="Großansicht">

  <!-- Thumbnails unten -->
  <div id="lightbox-thumbs">
    {% for img in images_list %}
      <img src="{{ img.url }}" data-index="{{ loop.index0 }}" alt="{{ img.title ?: img.filename }}">
    {% endfor %}
  </div>

</div>











<script>

document.addEventListener("DOMContentLoaded", function() {
  const showBtn = document.getElementById("show-gallery-btn");
  const hideBtn = document.getElementById("hide-gallery-btn");
  const gallery = document.getElementById("media-gallery");
  const images = Array.from(document.querySelectorAll("#media-gallery img"));
  const lightbox = document.getElementById("lightbox");
  const lightboxImg = document.getElementById("lightbox-img");
  const closeBtn = document.querySelector(".close-btn");
  const prevBtn = document.querySelector(".prev-btn");
  const nextBtn = document.querySelector(".next-btn");
  const zoomInBtn = document.querySelector(".zoom-in");
  const zoomOutBtn = document.querySelector(".zoom-out");
  const zoomInfo = document.getElementById("zoomInfo");
  const downloadSelectedBtn = document.getElementById("download-selected");
  const toggleSelectBtn = document.getElementById("toggle-select");

  const selectedCountSpan = document.createElement("span");
  selectedCountSpan.style.marginLeft = "8px";
  toggleSelectBtn.appendChild(selectedCountSpan);

  // Lightbox state
  let currentIndex = 0;
  let zoomLevel = 1;
  let moveX = 0, moveY = 0;
  let isDragging = false;
  let startX = 0, startY = 0;
  let isPinching = false, startDistance = 0, startZoom = 1;
  let swipeStartX = 0, swipeEndX = 0;
  let zoomInfoTimeout;

   function applyTransform(){
    lightboxImg.style.transform = `translate(${moveX}px, ${moveY}px) scale(${zoomLevel})`;
  }
  function updateZoomInfo(){
    zoomInfo.textContent = `${Math.round(zoomLevel * 100)}%`;
    zoomInfo.classList.add("visible");
    clearTimeout(zoomInfoTimeout);
    zoomInfoTimeout = setTimeout(()=> zoomInfo.classList.remove("visible"), 900);
  }

   function showImage(idx){
    if(!images.length) return;
    currentIndex = idx % images.length;
    if(currentIndex < 0) currentIndex += images.length;
    const src = images[currentIndex].getAttribute("src");
    lightboxImg.src = src;

    // Lightbox Download-Link aktualisieren
    const downloadLink = document.getElementById("lightbox-download");
    if (downloadLink) {
      downloadLink.href = src;
      const filename = src.split('/').pop();
      downloadLink.setAttribute("download", filename);
    }

    lightbox.classList.add("active");
    lightbox.setAttribute("aria-hidden", "false");
    zoomLevel = 1; moveX = 0; moveY = 0;
    applyTransform(); updateZoomInfo();
  }

  function hideLightbox(){
    lightbox.classList.remove("active");
    lightbox.setAttribute("aria-hidden", "true");
    zoomLevel = 1; moveX = 0; moveY = 0;
  }

  function showNext(){ showImage(currentIndex + 1); }
  function showPrev(){ showImage(currentIndex - 1); }

  // Bilder klicken öffnet Lightbox
  images.forEach((img, idx) => img.addEventListener("click", () => showImage(idx)));

  // Lightbox Buttons
  closeBtn.addEventListener("click", hideLightbox);
  nextBtn.addEventListener("click", showNext);
  prevBtn.addEventListener("click", showPrev);

  zoomInBtn.addEventListener("click", ()=>{
    zoomLevel += 0.25; applyTransform(); updateZoomInfo();
  });
  zoomOutBtn.addEventListener("click", ()=>{
    zoomLevel = Math.max(1, zoomLevel - 0.25);
    if(zoomLevel === 1){ moveX = 0; moveY = 0; }
    applyTransform(); updateZoomInfo();
  });

  document.addEventListener("keydown", e=>{
    if(!lightbox.classList.contains("active")) return;
    if(e.key === "Escape") hideLightbox();
    if(e.key === "ArrowRight") showNext();
    if(e.key === "ArrowLeft") showPrev();
    if(e.key === "+" || e.key === "="){ zoomLevel += 0.25; applyTransform(); updateZoomInfo(); }
    if(e.key === "-"){ zoomLevel = Math.max(1, zoomLevel - 0.25); if(zoomLevel===1){moveX=0;moveY=0;} applyTransform(); updateZoomInfo(); }
  });

  // Desktop zoom
  lightboxImg.addEventListener("wheel", e=>{
    if(!lightbox.classList.contains("active")) return;
    e.preventDefault();
    zoomLevel = Math.max(1, zoomLevel + (e.deltaY < 0 ? 0.25 : -0.25));
    if(zoomLevel === 1){ moveX=0; moveY=0; }
    applyTransform(); updateZoomInfo();
  });

  // Drag & Touch (Zoom > 1)
  lightboxImg.addEventListener("mousedown", e=>{
    if(zoomLevel <= 1) return;
    isDragging = true;
    startX = e.clientX - moveX;
    startY = e.clientY - moveY;
    lightboxImg.classList.add("dragging");
    e.preventDefault();
  });
  document.addEventListener("mousemove", e=>{
    if(!isDragging) return;
    moveX = e.clientX - startX;
    moveY = e.clientY - startY;
    applyTransform();
  });
  document.addEventListener("mouseup", ()=>{
    if(isDragging) { isDragging = false; lightboxImg.classList.remove("dragging"); }
  });

  lightboxImg.addEventListener("touchstart", e=>{
    if(!lightbox.classList.contains("active")) return;
    if(e.touches.length === 2){
      isPinching = true;
      const dx = e.touches[0].clientX - e.touches[1].clientX;
      const dy = e.touches[0].clientY - e.touches[1].clientY;
      startDistance = Math.sqrt(dx*dx + dy*dy);
      startZoom = zoomLevel;
    } else if(e.touches.length === 1 && zoomLevel > 1){
      isDragging = true;
      startX = e.touches[0].clientX - moveX;
      startY = e.touches[0].clientY - moveY;
    } else if(e.touches.length === 1){
      swipeStartX = e.touches[0].clientX;
    }
  }, {passive:false});

  lightboxImg.addEventListener("touchmove", e=>{
    if(!lightbox.classList.contains("active")) return;
    if(isPinching && e.touches.length === 2){
      e.preventDefault();
      const dx = e.touches[0].clientX - e.touches[1].clientX;
      const dy = e.touches[0].clientY - e.touches[1].clientY;
      const currentDistance = Math.sqrt(dx*dx + dy*dy);
      zoomLevel = Math.max(1, startZoom * (currentDistance / startDistance));
      applyTransform(); updateZoomInfo();
    } else if(isDragging && e.touches.length === 1){
      e.preventDefault();
      moveX = e.touches[0].clientX - startX;
      moveY = e.touches[0].clientY - startY;
      applyTransform();
    } else if(!isPinching && e.touches.length === 1){
      swipeEndX = e.touches[0].clientX;
    }
  }, {passive:false});

  lightboxImg.addEventListener("touchend", e=>{
    if(isPinching && e.touches.length < 2){ isPinching = false; }
    if(isDragging && e.touches.length === 0){ isDragging = false; }
    if(!isPinching && zoomLevel === 1 && swipeStartX && swipeEndX){
      const delta = swipeEndX - swipeStartX;
      if(Math.abs(delta) > 50){
        if(delta < 0) showNext(); else showPrev();
      }
    }
    swipeStartX = 0; swipeEndX = 0;
  });

  lightbox.addEventListener("click", function(e){
    if(e.target === lightbox) hideLightbox();
  });
  
  
  
  
  
  
  
  // --- Galerie anzeigen / verstecken ---
  showBtn.addEventListener("click", ()=>{
    window.scrollTo({ top: 0, behavior: 'smooth' });
    gallery.style.display="grid"; 
    showBtn.style.display="none"; 
    hideBtn.style.display="inline-block";
    downloadSelectedBtn.style.display="inline-block"; 
    toggleSelectBtn.style.display="inline-block";
  });
  hideBtn.addEventListener("click", () => {
  window.scrollTo({ top: 0, behavior: "smooth" });
  setTimeout(() => {
    gallery.style.display = "none";
    hideBtn.style.display = "none";
    showBtn.style.display = "inline-block";
    downloadSelectedBtn.style.display = "none";
    toggleSelectBtn.style.display = "none";
    document.querySelectorAll(".select-image").forEach(cb => (cb.checked = false));
    toggleSelectBtn.textContent = "Alle auswählen";
    selectedCountSpan.textContent = "";
  }, 400); // ~0.4 Sekunden nach dem Scrollstart
  
  
});



// --- Thumbnails für Lightbox ---
const lightboxThumbs = document.getElementById("lightbox-thumbs");
const thumbImages = Array.from(lightboxThumbs.querySelectorAll("img"));

function updateActiveThumb(){
  thumbImages.forEach(t => t.classList.remove("active"));
  const activeThumb = thumbImages[currentIndex];
  if(activeThumb) activeThumb.classList.add("active");
  // Optional: scrollen, dass aktive Thumb sichtbar ist
  activeThumb?.scrollIntoView({ behavior: "smooth", inline: "center" });
}

thumbImages.forEach((thumb, idx)=>{
  thumb.addEventListener("click", ()=>{
    showImage(idx);
    updateActiveThumb();
  });
});

// Update beim Lightbox-wechsel
function showImage(idx){
  if(!images.length) return;
  currentIndex = idx % images.length;
  if(currentIndex < 0) currentIndex += images.length;
  const src = images[currentIndex].getAttribute("src");
  lightboxImg.src = src;

  // Lightbox Download-Link aktualisieren
  const downloadLink = document.getElementById("lightbox-download");
  if (downloadLink) {
    downloadLink.href = src;
    const filename = src.split('/').pop();
    downloadLink.setAttribute("download", filename);
  }

  lightbox.classList.add("active");
  lightbox.setAttribute("aria-hidden", "false");
  zoomLevel = 1; moveX = 0; moveY = 0;
  applyTransform(); updateZoomInfo();
  updateActiveThumb();
}






  // --- Klick auf "Ausgewählte herunterladen" ---
  downloadSelectedBtn.addEventListener("click", async ()=>{
    const selected = Array.from(document.querySelectorAll(".select-image:checked"));
    if(selected.length===0){ alert("Bitte mindestens ein Bild auswählen."); return; }
    if(typeof JSZip==="undefined"||typeof saveAs==="undefined"){ alert("JSZip oder FileSaver nicht geladen!"); return; }
    const zip = new JSZip(); const folder=zip.folder("bilder");
    for(const cb of selected){
      const imgEl = cb.nextElementSibling; const url = imgEl.src;
      const filename = imgEl.dataset.filename || url.split("/").pop();
      const blob = await (await fetch(url)).blob();
      folder.file(filename, blob);
    }
    saveAs(await zip.generateAsync({type:"blob"}),"auswahl.zip");
  });

  // --- Alle auswählen / Auswahl aufheben + Zähler ---
  function updateToggleButton(){
    const checkboxes = document.querySelectorAll(".select-image");
    const selectedCount = Array.from(checkboxes).filter(cb=>cb.checked).length;
    toggleSelectBtn.textContent = selectedCount>0 ? "Auswahl aufheben" : "Alle auswählen";
    selectedCountSpan.textContent = selectedCount>0 ? `(${selectedCount})` : "";
    toggleSelectBtn.appendChild(selectedCountSpan);
  }
  toggleSelectBtn.addEventListener("click", ()=>{
    const checkboxes = document.querySelectorAll(".select-image");
    const allSelected = Array.from(checkboxes).every(cb=>cb.checked);
    checkboxes.forEach(cb=>cb.checked=!allSelected);
    updateToggleButton();
  });

  document.querySelectorAll(".select-image").forEach(cb=>cb.addEventListener("change",updateToggleButton));
  images.forEach(img=>{
    img.addEventListener("click", e=>{
      if(lightbox.classList.contains("active")) return;
      const checkbox = img.previousElementSibling;
      if(checkbox && checkbox.classList.contains("select-image")){ checkbox.checked=!checkbox.checked; updateToggleButton(); }
    });
  });
});











</script>

</body>
</html>
